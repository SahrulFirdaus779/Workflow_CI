name: CI-MLflow-Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  MLFLOW_TRACKING_URI: ""

jobs:
  train:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: MLProject
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.17.0 pandas==2.2.2 numpy==1.26.4 scikit-learn==1.4.2 joblib==1.4.2

      - name: Run MLflow Project (local env)
        run: |
          mlflow run . --env-manager local -P output-dir=outputs

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-ci-outputs
          path: MLProject/outputs
          if-no-files-found: error

      - name: Build Docker image from latest run
        if: env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''
        shell: bash
        run: |
          model_dir=$(find mlruns -path "*/artifacts/model" -type d | head -n 1)
          if [ -z "$model_dir" ]; then
            echo "No MLflow model artifacts found to build docker image." >&2
            exit 1
          fi
          user_lc=$(echo "$DOCKERHUB_USERNAME" | tr '[:upper:]' '[:lower:]')
          image_name="${user_lc}/workflow-ci-mlflow"
          echo "Using model path: $model_dir"
          echo "Building image: $image_name"
          MLFLOW_DOCKER_BUILDER_IMAGE="python:3.10-slim" mlflow models build-docker -m "$model_dir" -n "$image_name"
          echo "IMAGE_NAME=$image_name" >> $GITHUB_ENV

      - name: Push Docker image
        if: env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''
        shell: bash
        run: |
          if [ -z "$IMAGE_NAME" ]; then
            echo "IMAGE_NAME not set from previous step" >&2
            exit 1
          fi
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          docker push "$IMAGE_NAME"
