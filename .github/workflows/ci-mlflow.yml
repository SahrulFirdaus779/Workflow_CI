name: CI-MLflow-Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  MLFLOW_TRACKING_URI: ""

jobs:
  train:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: MLProject
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.17.0 pandas==2.2.2 numpy==1.26.4 scikit-learn==1.4.2 joblib==1.4.2

      - name: Run MLflow Project (local env)
        run: |
          mlflow run . --env-manager local -P output-dir=outputs

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-ci-outputs
          path: MLProject/outputs
          if-no-files-found: error

      # --- Replaced: build context creation + login + build/push using official actions ---
      - name: Build Docker image from latest run
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          model_dir=$(find mlruns -path "*/artifacts/model" -type d | head -n 1 || true)
          if [ -z "${model_dir:-}" ]; then
            echo "No MLflow model artifacts found to build docker image." >&2
            exit 1
          fi
          # keep original username for login, but use lowercase for image tags
          user_orig="${{ secrets.DOCKERHUB_USERNAME }}"
          user_lc=$(echo "$user_orig" | tr '[:upper:]' '[:lower:]')
          image_base="${user_lc}/workflow-ci-mlflow"
          echo "Using model path: $model_dir"
          echo "Preparing docker context for: $image_base"
          workdir="docker_ctx"
          rm -rf "$workdir" && mkdir -p "$workdir/model"
          cp -r "$model_dir"/* "$workdir/model/"
          printf '%s\n' \
            'FROM python:3.10-slim' \
            'WORKDIR /opt/model' \
            'COPY model /opt/model' \
            'RUN pip install --no-cache-dir -r /opt/model/requirements.txt || true \' \
            '    && pip install --no-cache-dir mlflow==2.17.0 \' \
            '    && pip install --no-cache-dir scikit-learn==1.4.2 pandas==2.2.2 numpy==1.26.4' \
            'EXPOSE 8080' \
            'ENV MLFLOW_MODEL_PATH=/opt/model' \
            'CMD ["mlflow", "models", "serve", "-m", "/opt/model", "-h", "0.0.0.0", "-p", "8080", "--env-manager", "local"]' \
            > "$workdir/Dockerfile"
          # export a stable env var for later steps
          echo "IMAGE_BASE=$image_base" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/build-push-action@v4
        with:
          context: docker_ctx
          file: docker_ctx/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:latest
            ${{ env.IMAGE_BASE }}:${{ github.sha }}

      - name: Echo pushed image tags
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "Pushed: ${{ env.IMAGE_BASE }}:latest"
          echo "Pushed: ${{ env.IMAGE_BASE }}:${{ github.sha }}"