name: CI-MLflow-Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Batasi permissions ke yang diperlukan
permissions:
  contents: read

jobs:
  train:
    runs-on: ubuntu-latest
    # Map secrets ke env di level job agar bisa dipakai di ekspresi if tanpa error validator.
    # Catatan: ini membuat DOCKERHUB_* tersedia sebagai env pada seluruh job — jangan cetak/echo nilainya.
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    defaults:
      run:
        working-directory: MLProject
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.17.0 pandas==2.2.2 numpy==1.26.4 scikit-learn==1.4.2 joblib==1.4.2

      - name: Run MLflow Project (local env)
        run: |
          mlflow run . --env-manager local -P output-dir=outputs

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-ci-outputs
          path: MLProject/outputs
          if-no-files-found: error

      # Hanya jalankan blok Docker bila DOCKERHUB secrets tersedia
      - name: Prepare docker context from latest MLflow run
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          model_dir=$(find mlruns -path "*/artifacts/model" -type d | head -n 1 || true)
          if [ -z "${model_dir:-}" ]; then
            echo "No MLflow model artifacts found to build docker image." >&2
            exit 1
          fi
          user_orig="$DOCKERHUB_USERNAME"
          # lowercase only for image name (login still uses original username)
          user_lc=$(echo "$user_orig" | tr '[:upper:]' '[:lower:]')
          image_base="${user_lc}/workflow-ci-mlflow"
          echo "Using model path: $model_dir"
          workdir="docker_ctx"
          rm -rf "$workdir" && mkdir -p "$workdir/model"
          cp -r "$model_dir"/* "$workdir/model/"
          printf '%s\n' \
            'FROM python:3.10-slim' \
            'WORKDIR /opt/model' \
            'COPY model /opt/model' \
            'RUN pip install --no-cache-dir -r /opt/model/requirements.txt || true \' \
            '    && pip install --no-cache-dir mlflow==2.17.0 \' \
            '    && pip install --no-cache-dir scikit-learn==1.4.2 pandas==2.2.2 numpy==1.26.4' \
            'EXPOSE 8080' \
            'ENV MLFLOW_MODEL_PATH=/opt/model' \
            'CMD ["mlflow", "models", "serve", "-m", "/opt/model", "-h", "0.0.0.0", "-p", "8080", "--env-manager", "local"]' \
            > "$workdir/Dockerfile"
          # Simpan nama image (tidak menyimpan token)
          echo "IMAGE_BASE=$image_base" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          # Gunakan secrets secara langsung sebagai input action; jangan echo token di logs
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/build-push-action@v4
        with:
          context: MLProject/docker_ctx
          file: MLProject/docker_ctx/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:latest
            ${{ env.IMAGE_BASE }}:${{ github.sha }}

      - name: Echo pushed image tags (safe — tidak menampilkan token)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        run: |
          echo "Pushed: ${{ env.IMAGE_BASE }}:latest"
          echo "Pushed: ${{ env.IMAGE_BASE }}:${{ github.sha }}"