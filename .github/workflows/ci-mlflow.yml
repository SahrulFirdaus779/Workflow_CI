name: CI-MLflow-Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Batasi permissions ke yang diperlukan
permissions:
  contents: read

jobs:
  train:
    runs-on: ubuntu-latest
    # Map secrets ke env di level job agar bisa dipakai di ekspresi if tanpa error validator.
    # Catatan: ini membuat DOCKERHUB_* tersedia sebagai env pada seluruh job — jangan cetak/echo nilainya.
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    defaults:
      run:
        working-directory: MLProject
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.17.0 pandas==2.2.2 numpy==1.26.4 scikit-learn==1.4.2 joblib==1.4.2

      - name: Run MLflow Project (local env)
        run: |
          mlflow run . --env-manager local -P output-dir=outputs

      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          run_id=$(ls -td mlruns/*/* | head -1 | awk -F'/' '{print $3}')
          echo "$run_id" > outputs/run_id.txt
          echo "RUN_ID=$run_id" >> $GITHUB_ENV

      - name: Upload run_id artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-run-id
          path: MLProject/outputs/run_id.txt
          if-no-files-found: error

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-ci-outputs
          path: MLProject/outputs
          if-no-files-found: error

      - name: Upload outputs to Google Drive (rclone)
        if: ${{ env.GDRIVE_CONFIG != '' }}
        run: |
          rclone copy MLProject/outputs gdrive:/mlflow-outputs/${{ env.RUN_ID }} --config "$GDRIVE_CONFIG"
        env:
          GDRIVE_CONFIG: ${{ secrets.GDRIVE_CONFIG }}

      # Hanya jalankan blok Docker bila DOCKERHUB secrets tersedia
      - name: Build Docker image with MLflow
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        run: |
          user_orig="$DOCKERHUB_USERNAME"
          user_lc=$(echo "$user_orig" | tr '[:upper:]' '[:lower:]')
          image_base="${user_lc}/workflow-ci-mlflow"
          echo "IMAGE_BASE=$image_base" >> $GITHUB_ENV
          mlflow models build-docker -m "mlruns/0/${RUN_ID}/artifacts/model" -n "$image_base:${RUN_ID}"

      - name: Log in to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          # Gunakan secrets secara langsung sebagai input action; jangan echo token di logs
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        run: |
          docker tag ${{ env.IMAGE_BASE }}:${RUN_ID} ${{ env.IMAGE_BASE }}:latest
          echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
          docker push ${{ env.IMAGE_BASE }}:${RUN_ID}
          docker push ${{ env.IMAGE_BASE }}:latest

      - name: Echo pushed image tags (safe — tidak menampilkan token)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        run: |
          echo "Pushed: ${{ env.IMAGE_BASE }}:latest"
          echo "Pushed: ${{ env.IMAGE_BASE }}:${RUN_ID}"